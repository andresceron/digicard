version: 2.1

slack-fail-post-step: &slack-fail-post-step
  post-steps:
  - slack/notify:
      event: fail
      custom: |
        {
          "text": "",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "SOCIALAR - FAILED :red_circle: (${CIRCLE_BUILD_NUM})",
                "emoji": true
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Project*: $CIRCLE_PROJECT_REPONAME \\n"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Branch*: $CIRCLE_BRANCH \\n"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Author*: $CIRCLE_USERNAME \\n"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Mentions*: $SLACK_PARAM_MENTIONS \\n"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Job*: ${CIRCLE_JOB} \\n"
                }
              ]
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Job"
                  },
                  "url": ${CIRCLE_BUILD_URL}
                }
              ]
            }
          ]
        }

orbs:
  heroku: circleci/heroku@1.2.3
  slack: circleci/slack@4.1.2

jobs:
  server_lint_test_build:
    working_directory: ~/digicard
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-server-dependencies-{{ .Branch }}-{{ checksum "package.json" }}
            - v1-server-dependencies-
      - run:
          name: server npm install
          command: npm install;
      - save_cache:
          key: v1-server-dependencies-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run:
          name: server lint
          command: cd ./server; xvfb-run -a npm run lint
      - run:
          name: server test
          command: cd ./server; xvfb-run -a npm run test
      - run:
          name: server build
          command: cd ./server;
      - slack/notify:
          channel: circleci
          custom: |
            {
                "blocks": [
                    {
                        "type": "header",
                        "text": {
                            "type": "plain_text",
                            "text": "SOCIALAR - FAILED :red_circle: (${CIRCLE_BUILD_NUM})",
                            "emoji": true
                        }
                    },
                    {
                        "type": "section",
                        "fields": [
                            {
                                "type": "mrkdwn",
                                "text": "*Project*: $CIRCLE_PROJECT_REPONAME \\n"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "*Branch*: $CIRCLE_BRANCH \\n"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "*Author*: $CIRCLE_USERNAME \\n"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "*Mentions*: $SLACK_PARAM_MENTIONS \\n"
                            },
                            {
                                "type": "mrkdwn",
                                "text": "*Job*: ${CIRCLE_JOB} \\n"
                            }
                        ]
                    },
                    {
                        "type": "actions",
                        "elements": [
                            {
                                "type": "button",
                                "text": {
                                    "type": "plain_text",
                                    "text": "View Job"
                                },
                                "url": ${CIRCLE_BUILD_URL}
                            }
                        ]
                    }
                ]
            }
          event: fail

  ui_lint_test_build:
    working_directory: ~/digicard
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-ui-dependencies-{{ .Branch }}-{{ checksum "package.json" }}
            - v1-ui-dependencies-
      - run:
          name: ui npm install
          command: cd ./ui && npm install;
      - save_cache:
          key: v1-ui-dependencies-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./ui/node_modules
      - run:
          name: ui lint
          command: cd ./ui; xvfb-run -a npm run lint
      - run:
          name: ui test
          command: cd ./ui; xvfb-run -a npm run test -- --watch=false --progress=false --browsers=ChromeNoSandbox
      - run:
          name: ui build
          command: cd ./ui; xvfb-run -a npm run build

  deploy_heroku:
    executor: heroku/default
    steps:
      - checkout
      - heroku/install
      - heroku/deploy-via-git

workflows:
  default:
    jobs:
      - server_lint_test_build:
         context: slack-secrets
         <<: *slack-fail-post-step
      - ui_lint_test_build: # your custom job; runs test suite 1
          requires: # test1 will not run until the `build` job is completed.
            - server_lint_test_build
          context: slack-secrets
          <<: *slack-fail-post-step
      - deploy_heroku: # another custom job; runs test suite 2,
          context: [slack-secrets]
          requires: # test2 is dependent on the success of job `test1`
            - server_lint_test_build
            - ui_lint_test_build
          post-steps:
            - slack/notify:
                event: always
                custom: |
                  {
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "SOCIALAR: SUCCESSFUL :red_circle:",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": "*Project*: $CIRCLE_PROJECT_REPONAME \\n"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Branch*: $CIRCLE_BRANCH \\n"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Author*: $CIRCLE_USERNAME \\n"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Mentions*: $SLACK_PARAM_MENTIONS \\n"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Job*: ${CIRCLE_JOB} \\n"
                          }
                        ]
                      },
                      {
                        "type": "actions",
                        "elements": [
                          {
                            "type": "button",
                            "text": {
                              "type": "plain_text",
                              "text": "View Job"
                            },
                            "url": ${CIRCLE_BUILD_URL}
                          }
                        ]
                      }
                    ]
                  }
          filters:
            branches:
              only:
                - main
                - /DIG-.*/
